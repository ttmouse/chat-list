<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试新增话术模态框</title>
    <link rel="stylesheet" href="content.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .widget-demo {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
        }
        
        .widget-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .widget-content {
            padding: 16px;
        }
        
        .btn-test {
            width: 100%;
            padding: 12px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .btn-test:hover {
            background: #218838;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>新增话术模态框测试页面</h1>
        <p>这个页面用于测试新的模态框功能是否正常工作。</p>
        
        <h2>测试步骤：</h2>
        <ol>
            <li>点击右侧浮动窗口中的"测试添加话术"按钮</li>
            <li>检查模态框是否正确显示</li>
            <li>测试表单验证功能</li>
            <li>测试保存功能</li>
            <li>检查控制台日志</li>
        </ol>
        
        <h2>调试信息：</h2>
        <div id="debugInfo" class="debug-info">
            等待操作...
        </div>
    </div>

    <!-- 模拟插件界面 -->
    <div class="widget-demo">
        <div class="widget-header">
            <span>话术助手 v1.1.1</span>
            <div>
                <button><svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6.85643 16.1891C5.59976 15.8149 4.48117 15.1203 3.59545 14.1999C3.92587 13.8083 4.125 13.3023 4.125 12.7499C4.125 11.5072 3.11764 10.4999 1.875 10.4999C1.79983 10.4999 1.72552 10.5036 1.65225 10.5108C1.55242 10.0227 1.5 9.51743 1.5 8.99986C1.5 8.21588 1.62029 7.45999 1.84342 6.74963C1.85393 6.74978 1.86446 6.74986 1.875 6.74986C3.11764 6.74986 4.125 5.74249 4.125 4.49986C4.125 4.14312 4.04197 3.80581 3.89422 3.50611C4.76156 2.69963 5.82019 2.09608 6.99454 1.771C7.36665 2.50039 8.12501 2.99987 9 2.99987C9.87499 2.99987 10.6334 2.50039 11.0055 1.771C12.1798 2.09608 13.2384 2.69963 14.1058 3.50611C13.958 3.80581 13.875 4.14312 13.875 4.49986C13.875 5.74249 14.8824 6.74986 16.125 6.74986C16.1355 6.74986 16.1461 6.74978 16.1566 6.74963C16.3797 7.45999 16.5 8.21588 16.5 8.99986C16.5 9.51743 16.4476 10.0227 16.3478 10.5108C16.2745 10.5036 16.2002 10.4999 16.125 10.4999C14.8824 10.4999 13.875 11.5072 13.875 12.7499C13.875 13.3023 14.0741 13.8083 14.4045 14.1999C13.5188 15.1203 12.4002 15.8149 11.1436 16.1891C10.8535 15.2818 10.0035 14.6249 9 14.6249C7.9965 14.6249 7.14645 15.2818 6.85643 16.1891Z" stroke="#333333" stroke-width="0.75" stroke-linejoin="round"/><path d="M9 11.625C10.4497 11.625 11.625 10.4497 11.625 9C11.625 7.55025 10.4497 6.375 9 6.375C7.55025 6.375 6.375 7.55025 6.375 9C6.375 10.4497 7.55025 11.625 9 11.625Z" stroke="#333333" stroke-width="0.75" stroke-linejoin="round"/></svg></button>
                <button>×</button>
            </div>
        </div>
        <div class="widget-content">
            <button class="btn-test btn-add-script">测试添加话术</button>
            <button class="btn-test" onclick="clearDebugInfo()">清空日志</button>
            <div style="color: #666; text-align: center; padding: 10px; font-size: 12px;">
                点击按钮测试功能
            </div>
        </div>
    </div>

    <script>
        // 模拟ChatListWidget类的部分功能
        class TestChatListWidget {
            constructor() {
                this.scripts = [];
                this.groups = [
                    { id: '1', name: '问候语' },
                    { id: '2', name: '服务话术' },
                    { id: '3', name: '结束语' }
                ];
                this.bindEvents();
                this.log('测试环境初始化完成');
            }
            
            log(message) {
                const debugInfo = document.getElementById('debugInfo');
                const timestamp = new Date().toLocaleTimeString();
                debugInfo.innerHTML += `[${timestamp}] ${message}\n`;
                debugInfo.scrollTop = debugInfo.scrollHeight;
                console.log(message);
            }
            
            bindEvents() {
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('btn-add-script')) {
                        try {
                            this.log('点击添加话术按钮');
                            this.showAddScriptModal();
                        } catch (error) {
                            this.log('错误: ' + error.message);
                        }
                    }
                });
            }
            
            showAddScriptModal() {
                this.log('显示添加话术模态框');
                
                const modalHTML = `
                    <div class="modal-overlay" id="addScriptModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3 class="modal-title">添加新话术</h3>
                                <button class="btn-close-modal">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="addScriptForm">
                                    <div class="form-group">
                                        <label class="form-label" for="modalScriptTitle">话术标题 *</label>
                                        <input type="text" id="modalScriptTitle" class="form-control" placeholder="请输入话术标题" required>
                                        <div id="titleError" class="error-message" style="display: none;"></div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="modalScriptGroup">所属分组</label>
                                        <select id="modalScriptGroup" class="form-control">
                                            <option value="">选择分组（可选）</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label" for="modalScriptContent">话术内容 *</label>
                                        <textarea id="modalScriptContent" class="form-control textarea" placeholder="请输入话术内容" required></textarea>
                                        <div id="contentError" class="error-message" style="display: none;"></div>
                                    </div>
                                </form>
                                
                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary btn-cancel-modal">取消</button>
                                    <button type="button" class="btn btn-primary btn-save-modal">保存话术</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const existingModal = document.getElementById('addScriptModal');
                if (existingModal) {
                    existingModal.remove();
                    this.log('移除已存在的模态框');
                }
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                this.log('模态框HTML已添加到页面');
                
                this.populateGroupOptions();
                this.bindModalEvents();
                
                const modal = document.getElementById('addScriptModal');
                modal.style.display = 'flex';
                this.log('模态框已显示');
                
                setTimeout(() => {
                    const titleInput = document.getElementById('modalScriptTitle');
                    if (titleInput) {
                        titleInput.focus();
                        this.log('焦点已设置到标题输入框');
                    }
                }, 100);
            }
            
            hideAddScriptModal() {
                this.log('隐藏添加话术模态框');
                const modal = document.getElementById('addScriptModal');
                if (modal) {
                    modal.remove();
                    this.log('模态框已从页面移除');
                }
            }
            
            populateGroupOptions() {
                const groupSelect = document.getElementById('modalScriptGroup');
                if (!groupSelect) {
                    this.log('错误: 未找到分组选择器');
                    return;
                }
                
                groupSelect.innerHTML = '<option value="">选择分组（可选）</option>';
                
                this.groups.forEach(group => {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name;
                    groupSelect.appendChild(option);
                });
                
                this.log(`已填充${this.groups.length}个分组选项`);
            }
            
            bindModalEvents() {
                this.log('绑定模态框事件');
                
                const closeBtn = document.querySelector('.btn-close-modal');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => this.hideAddScriptModal());
                }
                
                const cancelBtn = document.querySelector('.btn-cancel-modal');
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => this.hideAddScriptModal());
                }
                
                const saveBtn = document.querySelector('.btn-save-modal');
                if (saveBtn) {
                    saveBtn.addEventListener('click', () => this.saveNewScript());
                }
                
                const modal = document.getElementById('addScriptModal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target.classList.contains('modal-overlay')) {
                            this.hideAddScriptModal();
                        }
                    });
                }
                
                document.addEventListener('keydown', (e) => {
                    const modal = document.getElementById('addScriptModal');
                    if (modal && modal.style.display === 'flex') {
                        if (e.key === 'Escape') {
                            this.hideAddScriptModal();
                        } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                            this.saveNewScript();
                        }
                    }
                });
                
                this.log('模态框事件绑定完成');
            }
            
            validateModalForm() {
                const title = document.getElementById('modalScriptTitle')?.value.trim() || '';
                const content = document.getElementById('modalScriptContent')?.value.trim() || '';
                
                let isValid = true;
                
                const titleError = document.getElementById('titleError');
                if (titleError) {
                    if (!title) {
                        titleError.textContent = '请输入话术标题';
                        titleError.style.display = 'block';
                        isValid = false;
                    } else if (title.length > 50) {
                        titleError.textContent = '标题长度不能超过50个字符';
                        titleError.style.display = 'block';
                        isValid = false;
                    } else {
                        titleError.style.display = 'none';
                    }
                }
                
                const contentError = document.getElementById('contentError');
                if (contentError) {
                    if (!content) {
                        contentError.textContent = '请输入话术内容';
                        contentError.style.display = 'block';
                        isValid = false;
                    } else if (content.length > 1000) {
                        contentError.textContent = '内容长度不能超过1000个字符';
                        contentError.style.display = 'block';
                        isValid = false;
                    } else {
                        contentError.style.display = 'none';
                    }
                }
                
                this.log(`表单验证结果: ${isValid ? '通过' : '失败'}`);
                return isValid;
            }
            
            saveNewScript() {
                this.log('开始保存新话术');
                
                try {
                    if (!this.validateModalForm()) {
                        this.log('表单验证失败，停止保存');
                        return;
                    }
                    
                    const title = document.getElementById('modalScriptTitle')?.value.trim() || '';
                    const groupId = document.getElementById('modalScriptGroup')?.value || '';
                    const content = document.getElementById('modalScriptContent')?.value.trim() || '';
                    
                    const newScript = {
                        id: Date.now().toString(),
                        title,
                        content,
                        groupId,
                        createTime: new Date().toISOString()
                    };
                    
                    this.log('新话术数据: ' + JSON.stringify(newScript, null, 2));
                    
                    this.scripts.push(newScript);
                    this.log(`话术保存成功，当前总数: ${this.scripts.length}`);
                    
                    this.showSuccessMessage('话术添加成功！');
                    this.hideAddScriptModal();
                    
                } catch (error) {
                    this.log('保存新话术时出错: ' + error.message);
                }
            }
            
            showSuccessMessage(message) {
                this.log('显示成功消息: ' + message);
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.textContent = message;
                document.body.appendChild(successDiv);
                
                setTimeout(() => {
                    if (successDiv.parentNode) {
                        successDiv.parentNode.removeChild(successDiv);
                        this.log('成功消息已移除');
                    }
                }, 3000);
            }
        }
        
        function clearDebugInfo() {
            document.getElementById('debugInfo').innerHTML = '日志已清空\n';
        }
        
        // 初始化测试环境
        const testWidget = new TestChatListWidget();
    </script>
</body>
</html>