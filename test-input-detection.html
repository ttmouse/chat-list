<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>输入框检测调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #005a87;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .input-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-test input, .input-test textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .highlight {
            background: yellow !important;
            border: 2px solid red !important;
        }
        .valid {
            color: green;
            font-weight: bold;
        }
        .invalid {
            color: red;
            font-weight: bold;
        }
        .info {
            color: blue;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 12px;
        }
        th {
            background: #f5f5f5;
        }
        .element-info {
            max-width: 200px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>输入框检测调试页面</h1>
    
    <div class="section">
        <h2>测试输入框</h2>
        <div class="input-test">
            <label>普通文本输入框：</label>
            <input type="text" placeholder="请输入消息..." id="test-input-1">
        </div>
        <div class="input-test">
            <label>搜索输入框：</label>
            <input type="search" placeholder="搜索内容..." id="test-search">
        </div>
        <div class="input-test">
            <label>文本域：</label>
            <textarea placeholder="输入您的消息..." id="test-textarea"></textarea>
        </div>
        <div class="input-test">
            <label>可编辑div：</label>
            <div contenteditable="true" style="border: 1px solid #ddd; padding: 8px; min-height: 40px;" id="test-contenteditable">点击这里输入...</div>
        </div>
        <div class="input-test">
            <label>Role textbox：</label>
            <div role="textbox" style="border: 1px solid #ddd; padding: 8px; min-height: 40px;" id="test-role-textbox">Role textbox</div>
        </div>
    </div>
    
    <div class="section">
        <h2>输入框检测测试</h2>
        <button class="button" onclick="detectInputs()">检测所有输入框</button>
        <button class="button" onclick="testValidation()">测试验证逻辑</button>
        <button class="button" onclick="highlightInputs()">高亮显示输入框</button>
        <button class="button" onclick="clearHighlight()">清除高亮</button>
        <button class="button" onclick="testFillContent()">测试填充内容</button>
        <div id="detection-log" class="log"></div>
    </div>
    
    <div class="section">
        <h2>输入框详细信息</h2>
        <div id="input-details"></div>
    </div>
    
    <div class="section">
        <h2>当前焦点信息</h2>
        <button class="button" onclick="checkCurrentFocus()">检查当前焦点</button>
        <div id="focus-info" class="log"></div>
    </div>

    <script>
        let detectedInputs = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            const logDiv = document.getElementById('detection-log');
            const span = document.createElement('span');
            span.className = type;
            span.textContent = logEntry + '\n';
            logDiv.appendChild(span);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(logEntry);
        }
        
        // 复制扩展中的检测逻辑
        function isValidInput(element) {
            if (!element) return false;
            
            // 检查是否为有效的输入元素
            const tagName = element.tagName.toLowerCase();
            if (tagName === 'textarea') return true;
            if (tagName === 'input') {
                const type = element.type.toLowerCase();
                return ['text', 'search', 'url', 'email', 'password'].includes(type);
            }
            if (element.contentEditable === 'true') return true;
            
            // 检查是否有textbox角色
            if (element.getAttribute('role') === 'textbox') return true;
            
            // 检查是否有data-text属性
            if (element.getAttribute('data-text') === 'true') return true;
            
            // 检查特殊类名
            const className = element.className || '';
            if (className.includes('input_area') || className.includes('chat_textarea')) return true;
            
            return false;
        }
        
        function isValidInputElement(element) {
            if (!element) return false;
            
            // 检查元素是否可见
            const style = window.getComputedStyle(element);
            if (style.display === 'none' || style.visibility === 'hidden') {
                return false;
            }
            
            // 检查元素尺寸
            const rect = element.getBoundingClientRect();
            if (rect.width === 0 || rect.height === 0) {
                return false;
            }
            
            // 检查是否为只读或禁用
            if (element.readOnly || element.disabled) {
                return false;
            }
            
            // 对于contenteditable元素，确保真的可编辑
            if (element.contentEditable === 'true' || element.getAttribute('contenteditable') === 'true') {
                return true;
            }
            
            // 对于role="textbox"的元素
            if (element.getAttribute('role') === 'textbox') {
                return true;
            }
            
            // 对于传统input和textarea
            const tagName = element.tagName.toLowerCase();
            if (tagName === 'textarea' || tagName === 'input') {
                return true;
            }
            
            return false;
        }
        
        function isMessageInput(element) {
            if (!element) return false;
            
            // 检查是否为明显的搜索相关输入框
            const searchKeywords = ['search', '搜索', 'find', '查找', '筛选', 'filter', 'query'];
            
            // 检查placeholder
            const placeholder = element.placeholder || '';
            if (searchKeywords.some(keyword => placeholder.toLowerCase().includes(keyword.toLowerCase()))) {
                return false;
            }
            
            // 检查aria-label
            const ariaLabel = element.getAttribute('aria-label') || '';
            if (searchKeywords.some(keyword => ariaLabel.toLowerCase().includes(keyword.toLowerCase()))) {
                return false;
            }
            
            // 检查class名称
            const className = element.className || '';
            if (searchKeywords.some(keyword => className.toLowerCase().includes(keyword.toLowerCase()))) {
                return false;
            }
            
            // 检查父元素的class或id
            const parent = element.parentElement;
            if (parent) {
                const parentClass = parent.className || '';
                const parentId = parent.id || '';
                if (searchKeywords.some(keyword => 
                    parentClass.toLowerCase().includes(keyword.toLowerCase()) ||
                    parentId.toLowerCase().includes(keyword.toLowerCase())
                )) {
                    return false;
                }
            }
            
            // 排除明显的导航栏、头部区域的输入框
            const excludeSelectors = [
                'nav', 'header', '.navbar', '.header', '.top-bar', '.search-bar',
                '[role="navigation"]', '[role="banner"]'
            ];
            
            for (let selector of excludeSelectors) {
                if (element.closest(selector)) {
                    return false;
                }
            }
            
            // 如果输入框有明确的消息相关属性，直接通过
            const messageKeywords = ['message', '消息', 'comment', '评论', 'chat', '聊天', 'reply', '回复'];
            if (messageKeywords.some(keyword => 
                placeholder.toLowerCase().includes(keyword.toLowerCase()) ||
                ariaLabel.toLowerCase().includes(keyword.toLowerCase()) ||
                className.toLowerCase().includes(keyword.toLowerCase())
            )) {
                return true;
            }
            
            // 默认允许通过，除非明确是搜索框
            return true;
        }
        
        function findValidInputs() {
            const selectors = [
                'textarea:not([readonly]):not([disabled])',
                'input[type="text"]:not([readonly]):not([disabled])',
                'input[type="search"]:not([readonly]):not([disabled])',
                'input[type="url"]:not([readonly]):not([disabled])',
                'input[type="email"]:not([readonly]):not([disabled])',
                'input:not([type]):not([readonly]):not([disabled])',
                '[contenteditable="true"]',
                'div[role="textbox"]',
                'div[contenteditable="true"]',
                'div[data-text="true"]',
                '.input_area',
                '.chat_textarea',
                '[role="textbox"]',
                '[aria-label*="消息"]',
                '[aria-label*="message"]',
                '[placeholder*="消息"]',
                '[placeholder*="message"]'
            ];
            
            const inputs = [];
            selectors.forEach(selector => {
                try {
                    document.querySelectorAll(selector).forEach(input => {
                        if (isValidInputElement(input) && isMessageInput(input)) {
                            inputs.push(input);
                        }
                    });
                } catch (e) {
                    console.warn('选择器错误:', selector, e);
                }
            });
            
            return inputs;
        }
        
        function detectInputs() {
            log('开始检测输入框...', 'info');
            
            // 清除之前的检测结果
            detectedInputs = [];
            
            // 使用扩展的检测逻辑
            const validInputs = findValidInputs();
            detectedInputs = validInputs;
            
            log(`检测到 ${validInputs.length} 个有效输入框`, validInputs.length > 0 ? 'valid' : 'invalid');
            
            // 显示详细信息
            displayInputDetails(validInputs);
            
            if (validInputs.length === 0) {
                log('未找到可填充的输入框！', 'invalid');
                // 尝试检测所有输入相关元素
                const allInputs = document.querySelectorAll('input, textarea, [contenteditable="true"], [role="textbox"]');
                log(`页面总共有 ${allInputs.length} 个输入相关元素`, 'info');
                
                allInputs.forEach((input, index) => {
                    const isValid = isValidInput(input);
                    const isValidElement = isValidInputElement(input);
                    const isMessage = isMessageInput(input);
                    log(`元素 ${index + 1}: ${input.tagName} - 基础验证:${isValid} 元素验证:${isValidElement} 消息验证:${isMessage}`, 'info');
                });
            }
        }
        
        function displayInputDetails(inputs) {
            const detailsDiv = document.getElementById('input-details');
            
            if (inputs.length === 0) {
                detailsDiv.innerHTML = '<p class="invalid">未检测到有效输入框</p>';
                return;
            }
            
            let html = '<table><thead><tr><th>序号</th><th>标签</th><th>类型</th><th>ID</th><th>类名</th><th>占位符</th><th>可见性</th><th>尺寸</th></tr></thead><tbody>';
            
            inputs.forEach((input, index) => {
                const rect = input.getBoundingClientRect();
                const style = window.getComputedStyle(input);
                
                html += `<tr>
                    <td>${index + 1}</td>
                    <td>${input.tagName}</td>
                    <td>${input.type || input.getAttribute('role') || 'N/A'}</td>
                    <td class="element-info">${input.id || 'N/A'}</td>
                    <td class="element-info">${input.className || 'N/A'}</td>
                    <td class="element-info">${input.placeholder || 'N/A'}</td>
                    <td>${style.display !== 'none' && style.visibility !== 'hidden' ? '可见' : '隐藏'}</td>
                    <td>${Math.round(rect.width)}x${Math.round(rect.height)}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            detailsDiv.innerHTML = html;
        }
        
        function testValidation() {
            log('测试验证逻辑...', 'info');
            
            const testElements = [
                document.getElementById('test-input-1'),
                document.getElementById('test-search'),
                document.getElementById('test-textarea'),
                document.getElementById('test-contenteditable'),
                document.getElementById('test-role-textbox')
            ];
            
            testElements.forEach((element, index) => {
                if (element) {
                    const isValid = isValidInput(element);
                    const isValidElement = isValidInputElement(element);
                    const isMessage = isMessageInput(element);
                    const finalResult = isValidElement && isMessage;
                    
                    log(`测试元素 ${index + 1} (${element.id}):`, 'info');
                    log(`  基础验证: ${isValid}`, isValid ? 'valid' : 'invalid');
                    log(`  元素验证: ${isValidElement}`, isValidElement ? 'valid' : 'invalid');
                    log(`  消息验证: ${isMessage}`, isMessage ? 'valid' : 'invalid');
                    log(`  最终结果: ${finalResult}`, finalResult ? 'valid' : 'invalid');
                }
            });
        }
        
        function highlightInputs() {
            clearHighlight();
            const inputs = findValidInputs();
            inputs.forEach(input => {
                input.classList.add('highlight');
            });
            log(`高亮显示了 ${inputs.length} 个有效输入框`, 'info');
        }
        
        function clearHighlight() {
            document.querySelectorAll('.highlight').forEach(element => {
                element.classList.remove('highlight');
            });
        }
        
        function checkCurrentFocus() {
            const activeElement = document.activeElement;
            const focusDiv = document.getElementById('focus-info');
            
            let info = `当前焦点元素: ${activeElement ? activeElement.tagName : 'null'}\n`;
            
            if (activeElement) {
                info += `ID: ${activeElement.id || 'N/A'}\n`;
                info += `类名: ${activeElement.className || 'N/A'}\n`;
                info += `类型: ${activeElement.type || 'N/A'}\n`;
                info += `占位符: ${activeElement.placeholder || 'N/A'}\n`;
                info += `是否为有效输入: ${isValidInput(activeElement)}\n`;
                info += `是否为有效元素: ${isValidInputElement(activeElement)}\n`;
                info += `是否为消息输入: ${isMessageInput(activeElement)}\n`;
            }
            
            focusDiv.textContent = info;
        }
        
        function testFillContent() {
            const testContent = '这是测试填充的内容 - ' + new Date().toLocaleTimeString();
            const inputs = findValidInputs();
            
            if (inputs.length === 0) {
                log('未找到可填充的输入框！', 'invalid');
                return;
            }
            
            const targetInput = inputs[0];
            log(`尝试填充内容到: ${targetInput.tagName}#${targetInput.id}`, 'info');
            
            try {
                if (targetInput.tagName.toLowerCase() === 'input' || targetInput.tagName.toLowerCase() === 'textarea') {
                    targetInput.value = testContent;
                    targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                    targetInput.dispatchEvent(new Event('change', { bubbles: true }));
                } else if (targetInput.contentEditable === 'true') {
                    targetInput.textContent = testContent;
                    targetInput.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                log('内容填充成功！', 'valid');
            } catch (error) {
                log(`填充失败: ${error.message}`, 'invalid');
            }
        }
        
        // 页面加载时自动检测
        document.addEventListener('DOMContentLoaded', () => {
            log('页面加载完成，开始自动检测...', 'info');
            detectInputs();
        });
        
        // 监听焦点变化
        document.addEventListener('focusin', (e) => {
            log(`焦点切换到: ${e.target.tagName}#${e.target.id || 'no-id'}`, 'info');
        });
    </script>
</body>
</html>