<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修复测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .input-test {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .input-test input, .input-test textarea, .input-test div {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .rich-input {
            min-height: 40px;
            border: 1px solid #ddd;
            padding: 8px;
            background: white;
        }
        .chat-input {
            min-height: 30px;
            border: 1px solid #007cba;
            padding: 8px;
            background: #f9f9f9;
        }
        .message-input {
            min-height: 35px;
            border: 2px solid #28a745;
            padding: 8px;
            background: #f8f9fa;
        }
        .button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #005a87;
        }
        .highlight {
            background: yellow !important;
            border: 3px solid red !important;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>输入框检测修复测试</h1>
    
    <div class="test-section">
        <h2>各种类型的输入框</h2>
        
        <div class="input-test">
            <label>普通文本输入框：</label>
            <input type="text" placeholder="请输入消息..." id="normal-input">
        </div>
        
        <div class="input-test">
            <label>文本域：</label>
            <textarea placeholder="输入您的消息..." id="normal-textarea"></textarea>
        </div>
        
        <div class="input-test">
            <label>Rich Input (类似Zalo)：</label>
            <div class="rich-input" contenteditable="true" id="rich-input">点击这里输入...</div>
        </div>
        
        <div class="input-test">
            <label>Chat Input：</label>
            <div class="chat-input" contenteditable="true" id="chat-input">聊天输入框</div>
        </div>
        
        <div class="input-test">
            <label>Message Input：</label>
            <div class="message-input" contenteditable="true" id="message-input">消息输入框</div>
        </div>
        
        <div class="input-test">
            <label>Role Textbox：</label>
            <div role="textbox" style="border: 1px solid #ddd; padding: 8px; min-height: 40px;" id="role-textbox">Role textbox</div>
        </div>
        
        <div class="input-test">
            <label>Data Testid Input：</label>
            <div data-testid="compose-input" contenteditable="true" style="border: 1px solid #ddd; padding: 8px; min-height: 40px;" id="testid-input">Data testid input</div>
        </div>
        
        <div class="input-test">
            <label>搜索框 (应该被排除)：</label>
            <input type="search" placeholder="搜索内容..." id="search-input">
        </div>
    </div>
    
    <div class="test-section">
        <h2>测试控制</h2>
        <button class="button" onclick="testDetection()">测试检测逻辑</button>
        <button class="button" onclick="highlightInputs()">高亮有效输入框</button>
        <button class="button" onclick="clearHighlight()">清除高亮</button>
        <button class="button" onclick="testFill()">测试填充</button>
        <div id="test-log" class="log"></div>
    </div>
    
    <div class="test-section">
        <h2>模拟Zalo页面结构</h2>
        <div id="chat-input-container-id">
            <div class="input-test">
                <label>Zalo容器内的输入框：</label>
                <div contenteditable="true" style="border: 1px solid #ddd; padding: 8px; min-height: 40px;" id="zalo-input">Zalo输入框</div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('test-log');
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        // 复制修复后的检测逻辑
        function isValidInputElement(element) {
            if (!element) return false;
            
            // 检查元素是否可见 - 放宽条件，允许一些隐藏但实际可用的元素
            const style = window.getComputedStyle(element);
            if (style.display === 'none') {
                return false;
            }
            
            // 检查元素尺寸 - 放宽条件，允许较小的元素
            const rect = element.getBoundingClientRect();
            if (rect.width === 0 && rect.height === 0) {
                return false;
            }
            
            // 检查是否为只读或禁用
            if (element.readOnly || element.disabled) {
                return false;
            }
            
            // 对于contenteditable元素，确保真的可编辑
            if (element.contentEditable === 'true' || element.getAttribute('contenteditable') === 'true') {
                return true;
            }
            
            // 对于role="textbox"的元素
            if (element.getAttribute('role') === 'textbox') {
                return true;
            }
            
            // 对于传统input和textarea
            const tagName = element.tagName.toLowerCase();
            if (tagName === 'textarea' || tagName === 'input') {
                return true;
            }
            
            // 检查是否有特殊的输入框属性
            if (element.getAttribute('data-text') === 'true') {
                return true;
            }
            
            // 检查是否有输入框相关的类名
            const className = element.className || '';
            if (className.includes('input') || className.includes('textarea') || className.includes('textbox')) {
                return true;
            }
            
            return false;
        }
        
        function isMessageInput(element) {
            if (!element) return false;
            
            // 检查是否为明显的搜索相关输入框 - 只排除明确的搜索框
            const searchKeywords = ['search', '搜索', 'find', '查找'];
            
            // 检查placeholder - 只检查明确的搜索关键词
            const placeholder = element.placeholder || '';
            if (searchKeywords.some(keyword => placeholder.toLowerCase().includes(keyword.toLowerCase()))) {
                return false;
            }
            
            // 检查aria-label - 只检查明确的搜索关键词
            const ariaLabel = element.getAttribute('aria-label') || '';
            if (searchKeywords.some(keyword => ariaLabel.toLowerCase().includes(keyword.toLowerCase()))) {
                return false;
            }
            
            // 检查class名称 - 只检查明确的搜索关键词
            const className = element.className || '';
            if (searchKeywords.some(keyword => className.toLowerCase().includes(keyword.toLowerCase()))) {
                return false;
            }
            
            // 排除明显的导航栏、头部区域的输入框
            const excludeSelectors = [
                'nav', 'header', '.navbar', '.header', '.top-bar', '.search-bar',
                '[role="navigation"]', '[role="banner"]'
            ];
            
            for (let selector of excludeSelectors) {
                if (element.closest(selector)) {
                    return false;
                }
            }
            
            // 检查是否为Zalo页面的聊天输入框
            if (element.closest('#chat-input-container-id')) {
                return true;
            }
            
            // 如果输入框有明确的消息相关属性，直接通过
            const messageKeywords = ['message', '消息', 'comment', '评论', 'chat', '聊天', 'reply', '回复', 'input', 'text'];
            if (messageKeywords.some(keyword => 
                placeholder.toLowerCase().includes(keyword.toLowerCase()) ||
                ariaLabel.toLowerCase().includes(keyword.toLowerCase()) ||
                className.toLowerCase().includes(keyword.toLowerCase())
            )) {
                return true;
            }
            
            // 检查是否在聊天或消息相关的容器中
            const chatContainers = [
                '[id*="chat"]', '[class*="chat"]',
                '[id*="message"]', '[class*="message"]',
                '[id*="input"]', '[class*="input"]',
                '[id*="compose"]', '[class*="compose"]'
            ];
            
            for (let selector of chatContainers) {
                if (element.closest(selector)) {
                    return true;
                }
            }
            
            // 默认允许通过，除非明确是搜索框
            return true;
        }
        
        function findValidInputs() {
            const selectors = [
                'textarea:not([readonly]):not([disabled])',
                'input[type="text"]:not([readonly]):not([disabled])',
                'input[type="search"]:not([readonly]):not([disabled])',
                'input[type="url"]:not([readonly]):not([disabled])',
                'input[type="email"]:not([readonly]):not([disabled])',
                'input:not([type]):not([readonly]):not([disabled])',
                '[contenteditable="true"]',
                'div[role="textbox"]',
                'div[contenteditable="true"]',
                'div[data-text="true"]',
                '.input_area',
                '.chat_textarea',
                '#chat-input-container-id',
                '#chat-input-container-id input',
                '#chat-input-container-id textarea',
                '#chat-input-container-id [contenteditable="true"]',
                '#chat-input-container-id [role="textbox"]',
                '[class*="rich-input"]',
                '[class*="input-rich"]',
                '[class*="chat-input"]',
                '[class*="message-input"]',
                '[class*="compose"]',
                '[data-testid*="input"]',
                '[data-testid*="compose"]',
                '[data-testid*="message"]',
                '[role="textbox"]',
                '[aria-label*="消息"]',
                '[aria-label*="message"]',
                '[aria-label*="评论"]',
                '[aria-label*="comment"]',
                '[placeholder*="消息"]',
                '[placeholder*="message"]',
                '[placeholder*="评论"]',
                '[placeholder*="comment"]',
                '[placeholder*="输入"]',
                '[placeholder*="input"]',
                '[placeholder*="text"]',
                '[placeholder*="type"]'
            ];
            
            const inputs = [];
            selectors.forEach(selector => {
                try {
                    document.querySelectorAll(selector).forEach(input => {
                        if (isValidInputElement(input) && isMessageInput(input)) {
                            inputs.push(input);
                        }
                    });
                } catch (e) {
                    console.warn('选择器错误:', selector, e);
                }
            });
            
            return inputs;
        }
        
        function testDetection() {
            log('开始测试检测逻辑...');
            
            const allInputs = document.querySelectorAll('input, textarea, [contenteditable="true"], [role="textbox"]');
            log(`页面总共有 ${allInputs.length} 个输入相关元素`);
            
            allInputs.forEach((input, index) => {
                const isValid = isValidInputElement(input);
                const isMessage = isMessageInput(input);
                const finalResult = isValid && isMessage;
                
                log(`元素 ${index + 1} (${input.id || input.tagName}): 有效=${isValid}, 消息=${isMessage}, 最终=${finalResult}`);
            });
            
            const validInputs = findValidInputs();
            log(`检测到 ${validInputs.length} 个有效输入框`);
            
            if (validInputs.length > 0) {
                log('✅ 检测成功！');
            } else {
                log('❌ 检测失败，未找到有效输入框');
            }
        }
        
        function highlightInputs() {
            clearHighlight();
            const inputs = findValidInputs();
            inputs.forEach(input => {
                input.classList.add('highlight');
            });
            log(`高亮了 ${inputs.length} 个有效输入框`);
        }
        
        function clearHighlight() {
            document.querySelectorAll('.highlight').forEach(element => {
                element.classList.remove('highlight');
            });
        }
        
        function testFill() {
            const inputs = findValidInputs();
            if (inputs.length === 0) {
                log('❌ 未找到可填充的输入框');
                return;
            }
            
            const testContent = '测试填充内容 - ' + new Date().toLocaleTimeString();
            const input = inputs[0];
            
            try {
                if (input.tagName.toLowerCase() === 'input' || input.tagName.toLowerCase() === 'textarea') {
                    input.value = testContent;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                } else if (input.contentEditable === 'true') {
                    input.textContent = testContent;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                }
                
                log(`✅ 成功填充到: ${input.id || input.tagName}`);
            } catch (error) {
                log(`❌ 填充失败: ${error.message}`);
            }
        }
        
        // 页面加载时自动测试
        document.addEventListener('DOMContentLoaded', () => {
            log('页面加载完成，开始自动测试...');
            testDetection();
        });
    </script>
</body>
</html>